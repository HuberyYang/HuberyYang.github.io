I"OŸ<p>è½¬è‡ª: <a href="http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/">http://xelz.info/blog/2018/11/24/all-you-need-to-know-about-bitcode/</a></p>

<h2 id="0x00-å‰è¨€">0x00 å‰è¨€</h2>

<p>è‹¹æœåœ¨WWDC 2015å¤§ä¼šä¸Šå¼•å…¥äº†bitcodeï¼Œéšååœ¨Xcode7ä¸­æ·»åŠ äº†åœ¨äºŒè¿›åˆ¶ä¸­åµŒå…¥bitcode(Enable Bitcode)çš„åŠŸèƒ½ï¼Œå¹¶ä¸”é»˜è®¤è®¾ç½®ä¸ºå¼€å¯çŠ¶æ€ã€‚å¾ˆå¤šå¼€å‘è€…åœ¨é›†æˆç¬¬ä¸‰æ–¹SDKçš„æ—¶å€™éƒ½è¢«bitcodeå‘è¿‡ä¸€æŠŠï¼Œç„¶ågoogleç™¾åº¦ä¸€ç•ªå‘ç°åªè¦å…³é—­bitcodeå°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†å¼€å‘è€…éƒ½ä¸æ¸…æ¥šbitcodeåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚è¿™ç¯‡æ–‡æ¡£å°†ç»™å¤§å®¶è¯¦ç»†åœ°ä»‹ç»ä¸bitcodeæœ‰å…³çš„å†…å®¹ã€‚</p>

<h2 id="0x01-ä»€ä¹ˆæ˜¯bitcode">0x01 ä»€ä¹ˆæ˜¯bitcode</h2>

<p>ç ”ç©¶bitcodeä¹‹å‰éœ€è¦å…ˆäº†è§£ä¸€ä¸‹LLVMï¼Œå› ä¸ºbitcodeæ˜¯ç”±LLVMå¼•å…¥çš„ä¸€ç§ä¸­é—´ä»£ç (Intermediate Representationï¼Œç®€ç§°IR)ï¼Œå®ƒæ˜¯æºä»£ç è¢«ç¼–è¯‘ä¸ºäºŒè¿›åˆ¶æœºå™¨ç è¿‡ç¨‹ä¸­çš„ä¸­é—´è¡¨ç¤ºå½¢æ€ï¼Œå®ƒæ—¢ä¸æ˜¯æºä»£ç ï¼Œä¹Ÿä¸æ˜¯æœºå™¨ç ã€‚ä»ä»£ç ç»„ç»‡ç»“æ„ä¸Šçœ‹å®ƒæ¯”è¾ƒæ¥è¿‘æœºå™¨ç ï¼Œä½†æ˜¯åœ¨å‡½æ•°å’ŒæŒ‡ä»¤å±‚é¢ä½¿ç”¨äº†å¾ˆå¤šé«˜çº§è¯­è¨€çš„ç‰¹æ€§ã€‚</p>

<p>LLVMæ˜¯ä¸€å¥—ä¼˜ç§€çš„ç¼–è¯‘å™¨æ¡†æ¶ï¼Œç›®å‰NDK/Xcodeå‡é‡‡ç”¨LLVMä½œä¸ºé»˜è®¤çš„ç¼–è¯‘å™¨ã€‚LLVMçš„ç¼–è¯‘è¿‡ç¨‹å¯ä»¥ç®€å•åˆ†ä¸º3ä¸ªéƒ¨åˆ†:</p>

<p><img src="http://xelz.info/assets/2018/RetargetableCompiler.png" alt="" /></p>

<p>å›¾æ¥è‡ª http://www.aosabook.org/en/llvm.html</p>

<ol>
  <li>å‰ç«¯(Frontend)ï¼Œè´Ÿè´£æŠŠå„ç§ç±»å‹çš„æºä»£ç ç¼–è¯‘ä¸ºä¸­é—´è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯bitcodeï¼Œåœ¨LLVMä½“ç³»å†…ï¼Œä¸åŒçš„è¯­è¨€æœ‰ä¸åŒçš„ç¼–è¯‘å™¨å‰ç«¯ï¼Œæœ€å¸¸è§çš„å¦‚clangè´Ÿè´£c/c++/ocçš„ç¼–è¯‘ï¼Œflangè´Ÿè´£fortrançš„ç¼–è¯‘ï¼Œswiftcè´Ÿè´£swiftçš„ç¼–è¯‘ç­‰ç­‰</li>
  <li>ä¼˜åŒ–(Optimizer)ï¼Œè´Ÿè´£å¯¹bitcodeè¿›è¡Œå„ç§ç±»å‹çš„ä¼˜åŒ–ï¼Œå°†bitcodeä»£ç è¿›è¡Œä¸€äº›é€»è¾‘ç­‰ä»·çš„è½¬æ¢ï¼Œä½¿å¾—ä»£ç çš„æ‰§è¡Œæ•ˆç‡æ›´é«˜ï¼Œä½“ç§¯æ›´å°ï¼Œæ¯”å¦‚DeadStrip/SimplifyCFG</li>
  <li>åç«¯(Backend)ï¼Œä¹Ÿå«CodeGeneratorï¼Œè´Ÿè´£æŠŠä¼˜åŒ–åçš„bitcodeç¼–è¯‘ä¸ºæŒ‡å®šç›®æ ‡æ¶æ„çš„æœºå™¨ç ï¼Œæ¯”å¦‚X86Backendè´Ÿè´£æŠŠbitcodeç¼–è¯‘ä¸ºx86æŒ‡ä»¤é›†çš„æœºå™¨ç </li>
</ol>

<p>åœ¨è¿™ä¸ªä½“ç³»ä¸­ï¼Œä¸åŒè¯­è¨€çš„æºä»£ç å°†ä¼šè¢«è½¬åŒ–ä¸ºç»Ÿä¸€çš„bitcodeæ ¼å¼ï¼Œä¸‰ä¸ªæ¨¡å—å¯ä»¥å……åˆ†å¤ç”¨ï¼Œé˜²æ­¢é‡å¤é€ è½®å­ã€‚å¦‚æœè¦å¼€å‘ä¸€é—¨æ–°çš„<code class="highlighter-rouge">xè¯­è¨€</code>ï¼Œåªéœ€è¦é€ ä¸€ä¸ªxè¯­è¨€çš„å‰ç«¯ï¼Œå°†xè¯­è¨€çš„æºä»£ç ç¼–è¯‘ä¸ºbitcodeï¼Œä¼˜åŒ–å’Œåç«¯çš„äº‹æƒ…å®Œå…¨ä¸ç”¨ç®¡ã€‚åŒç†ï¼Œå¦‚æœæ–°çš„èŠ¯ç‰‡æ¶æ„é—®ä¸–ï¼Œåˆ™åªéœ€è¦åŸºäºLLVMé‡æ–°å†™ä¸€å¥—ç›®æ ‡å¹³å°çš„åç«¯ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p>

<h2 id="0x02-bitcodeåˆæ¢">0x02 bitcodeåˆæ¢</h2>

<p>æ—¢ç„¶bitcodeæ˜¯ä»£ç çš„ä¸€ç§è¡¨ç¤ºå½¢å¼ï¼Œå› æ­¤å®ƒä¹Ÿä¼šæœ‰è‡ªå·±çš„ä¸€å¥—ç‹¬ç«‹çš„è¯­æ³•ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ä¸€æ¢ç©¶ç«Ÿï¼Œè¿™é‡Œä»¥clangä¸ºä¾‹ï¼Œswiftçš„æ“ä½œå’Œç»“æœå¯èƒ½ç¨æœ‰ä¸åŒã€‚</p>

<p>æœ¬æ–‡æ‰€æ¶‰åŠçš„å†…å®¹å¯ä»¥è‡ªè¡Œæ“ä½œï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½<a href="http://xelz.info/assets/2018/bitcode-demo.zip">æˆ‘å†™è¿™ç¯‡æ–‡ç« æ—¶ä¿å­˜çš„å‰¯æœ¬</a></p>

<p>å…ˆç¼–å†™ä¸€æ®µhelloworldä»£ç (test.c)ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#include &lt;stdio.h&gt;
int main(void) {
    printf("hello, world.\n");
    return 0;
}
</code></pre></div></div>

<p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥å°†æºä»£ç ç¼–è¯‘ä¸ºobjectæ–‡ä»¶:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -c test.c -o test.o
$ file test.o
test.o: Mach-O 64-bit object x86_64
</code></pre></div></div>

<p>å…¶å®ï¼Œè¿™ä¸ªå‘½ä»¤åŒæ—¶å®Œæˆäº†å‰ç«¯ã€ä¼˜åŒ–ã€åç«¯ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¯ä»¥é€šè¿‡ <code class="highlighter-rouge">-emit-llvm -c</code> å°†å‰ç«¯è¿™ä¸€æ­¥å•ç‹¬æ‹†å‡ºæ¥ï¼Œè¿™æ ·å°±å¯ä»¥çœ‹åˆ°bitcodeäº†:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -emit-llvm -c test.c -o test.bc # å°†æºä»£ç ç¼–è¯‘ä¸ºbitcode
$ file test.bc
test.bc: LLVM bitcode, wrapper x86_64
$ clang -c test.bc -o test.bc.o # å°†bitcodeç¼–è¯‘ä¸ºobject
$ file test.bc.o
test.bc.o: Mach-O 64-bit object x86_64
$ md5 test.bc.o test.o
MD5 (test.bc.o) = 70ea3a520c26df84d1f7ca552e8e6620
MD5 (test.o) = 70ea3a520c26df84d1f7ca552e8e6620
</code></pre></div></div>

<p>bitcodeæ–‡ä»¶ä½¿ç”¨åç¼€å<code class="highlighter-rouge">.bc</code>è¡¨ç¤ºï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå°†bitcodeæ–‡ä»¶ä½œä¸ºclangçš„è¾“å…¥ï¼Œç¼–å‡ºçš„objectæ–‡ä»¶è·Ÿç›´æ¥ç¼–æºä»£ç æ˜¯ç›¸åŒçš„ã€‚ç„¶ååœ¨æ¥çœ‹ä¸€ä¸‹bitcodeæ–‡ä»¶:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ hexdump -C test.bc  | head
00000000  de c0 17 0b 00 00 00 00  14 00 00 00 08 0b 00 00  |................|
00000010  07 00 00 01 42 43 c0 de  35 14 00 00 07 00 00 00  |....BC..5.......|
00000020  62 0c 30 24 96 96 a6 a5  f7 d7 7f 4d d3 b4 5f d7  |b.0$.......M.._.|
00000030  3e 9e fb f9 4f 0b 51 80  4c 01 00 00 21 0c 00 00  |&gt;...O.Q.L...!...|
00000040  74 02 00 00 0b 02 21 00  02 00 00 00 13 00 00 00  |t.....!.........|
00000050  07 81 23 91 41 c8 04 49  06 10 32 39 92 01 84 0c  |..#.A..I..29....|
00000060  25 05 08 19 1e 04 8b 62  80 10 45 02 42 92 0b 42  |%......b..E.B..B|
00000070  84 10 32 14 38 08 18 4b  0a 32 42 88 48 90 14 20  |..2.8..K.2B.H.. |
00000080  43 46 88 a5 00 19 32 42  04 49 0e 90 11 22 c4 50  |CF....2B.I...".P|
00000090  41 51 81 8c e1 83 e5 8a  04 21 46 06 51 18 00 00  |AQ.......!F.Q...|
</code></pre></div></div>

<p>é€šè¿‡hexdumpå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ–‡ä»¶å¹¶éæ–‡æœ¬æ–‡ä»¶ï¼Œå…¨æ˜¯ä¹±ç ï¼Œè¿™æ ·çš„æ–‡ä»¶æ˜¯å¾ˆéš¾åˆ†æçš„ã€‚å…¶å®LLVMæä¾›äº†<code class="highlighter-rouge">llvm-dis</code>/ <code class="highlighter-rouge">llvm-as</code> ä¸¤ä¸ªå·¥å…·ï¼Œç”¨äºå°†bitcodeåœ¨äºŒè¿›åˆ¶æ ¼å¼å’Œå¯è¯»çš„æ–‡æœ¬æ ¼å¼ä¹‹é—´è¿›è¡Œç›¸äº’çš„è½¬åŒ–ï¼Œä½†é—æ†¾çš„æ˜¯Xcodeçš„ç¼–è¯‘å™¨å·¥å…·é“¾ä¸­å¹¶æ²¡æœ‰é™„å¸¦è¿™ä¸ªå‘½ä»¤ï¼Œå› æ­¤åªèƒ½å¦å¯»ä»–æ³•ã€‚</p>

<p>æˆ‘ä»¬çŸ¥é“é€šè¿‡ç¼–è¯‘å™¨çš„<code class="highlighter-rouge">-S</code>å‚æ•°å¯ä»¥å°†æºä»£ç ç¼–è¯‘ä¸ºæ–‡æœ¬çš„assemblyä»£ç ï¼Œä¸è¿›è¡Œæœ€åä¸€æ­¥assemblyåˆ°æœºå™¨ç çš„ç¿»è¯‘å·¥ä½œï¼Œè€Œassemblyå’Œæœºå™¨ç æ˜¯ç­‰ä»·çš„ä¸¤ç§è¡¨ç¤ºå½¢å¼ï¼ŒbitcodeåŒæ ·ä¹Ÿæ˜¯æœ‰æ–‡æœ¬å’ŒäºŒè¿›åˆ¶(bitcode)ä¸¤ç§ç­‰ä»·è¡¨ç¤ºå½¢å¼ï¼Œclangä¹Ÿä¸ºbitcodeä¿ç•™äº†è¿™ä¸€ç‰¹æ€§ï¼Œå¯ä»¥é€šè¿‡<code class="highlighter-rouge">-emit-llvm -S</code> å°†æºä»£ç ç¼–è¯‘ä¸ºæ–‡æœ¬æ ¼å¼çš„bitcodeï¼Œ ä¹Ÿå«åšLLVM Assembly Languageï¼Œä¸€èˆ¬åç¼€åä½¿ç”¨<code class="highlighter-rouge">.ll</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -emit-llvm -S test.c -o test.ll # å°†æºä»£ç ç¼–è¯‘ä¸ºLLVM Assembly
</code></pre></div></div>

<p>test.llçš„å…¨éƒ¨å†…å®¹å¦‚ä¸‹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// ModuleID = 'test.c'
source_filename = "test.c"
target datalayout = "e-m:o-i64:64-f80:128-n8:16:32:64-S128"
target triple = "x86_64-apple-macosx10.14.0"

@.str = private unnamed_addr constant [15 x i8] c"hello, world.\0A\00", align 1

// Function Attrs: noinline nounwind optnone ssp uwtable
define i32 @main() #0 {
  %1 = alloca i32, align 4
  store i32 0, i32* %1, align 4
  %2 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([15 x i8], [15 x i8]* @.str, i32 0, i32 0))
  ret i32 0
}

declare i32 @printf(i8*, ...) #1

attributes #0 = { noinline nounwind optnone ssp uwtable "correctly-rounded-divide-sqrt-fp-math"="false" "disable-tail-calls"="false" "less-precise-fpmad"="false" "no-frame-pointer-elim"="true" "no-frame-pointer-elim-non-leaf" "no-infs-fp-math"="false" "no-jump-tables"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="false" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "unsafe-fp-math"="false" "use-soft-float"="false" }
attributes #1 = { "correctly-rounded-divide-sqrt-fp-math"="false" "disable-tail-calls"="false" "less-precise-fpmad"="false" "no-frame-pointer-elim"="true" "no-frame-pointer-elim-non-leaf" "no-infs-fp-math"="false" "no-nans-fp-math"="false" "no-signed-zeros-fp-math"="false" "no-trapping-math"="false" "stack-protector-buffer-size"="8" "target-cpu"="penryn" "target-features"="+cx16,+fxsr,+mmx,+sahf,+sse,+sse2,+sse3,+sse4.1,+ssse3,+x87" "unsafe-fp-math"="false" "use-soft-float"="false" }

!llvm.module.flags = !{!0, !1}
!llvm.ident = !{!2}

!0 = !{i32 1, !"wchar_size", i32 4}
!1 = !{i32 7, !"PIC Level", i32 2}
!2 = !{!"Apple LLVM version 10.0.0 (clang-1000.11.45.5)"}
</code></pre></div></div>

<p>è¿™æ ·çœ‹ä¸Šå»å°±å¾ˆæ¸…æ™°æ˜äº†äº†ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸‹å‡½æ•°å®šä¹‰è¿™éƒ¨åˆ†ï¼Œæˆ‘åŠ äº†ä¸€äº›æ³¨é‡Šæ–¹ä¾¿ç†è§£</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// å®šä¹‰å…¨å±€å¸¸é‡ @.str, å†…å®¹åˆå§‹åŒ–ä¸º 'hello, world.\n\0'
@.str = private unnamed_addr constant [15 x i8] c"hello, world.\0A\00", align 1

// Function Attrs: noinline nounwind optnone ssp uwtable
define i32 @main() #0 { ; å®šä¹‰å‡½æ•° @mainï¼Œè¿”å›å€¼ä¸ºi32ç±»å‹
  %1 = alloca i32, align 4 ; å£°æ˜å˜é‡ %1 = åˆ†é…i32çš„å†…å­˜ç©ºé—´
  store i32 0, i32* %1, align 4 ; å°† 0 å­˜å…¥ %1 çš„å†…å­˜ç©ºé—´
  %2 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([15 x i8], [15 x i8]* @.str, i32 0, i32 0)) ; è°ƒç”¨ @printf å‡½æ•°ï¼Œå¹¶å°† @.str çš„åœ°å€ä½œä¸ºå‚æ•°
  ret i32 0 ; è¿”å› 0
}

declare i32 @printf(i8*, ...) #1 ; å£°æ˜ä¸€ä¸ªå¤–éƒ¨å‡½æ•° @printf
</code></pre></div></div>

<p>è¿™æ®µä»£ç ä¸éš¾é˜…è¯»ï¼Œ å…¶å«ä¹‰å’Œé€»è¾‘ä¸æˆ‘ä»¬æ‰€å†™çš„æºä»£ç åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯ç”¨äº†å¦å¤–ä¸€ç§è¯­æ³•è¡¨ç¤ºå‡ºæ¥ã€‚å› ä¸ºæ²¡æœ‰ç»è¿‡ä¼˜åŒ–ï¼Œå‡½æ•°ä¸­çš„å‰ä¸¤æ¡è¯­å¥å…¶å®æ˜¯å¤šä½™çš„ï¼Œè¿™åœ¨ä¹‹åçš„ä¼˜åŒ–é˜¶æ®µä¼šè¢«æ¶ˆé™¤(dead_strip)ã€‚bitcodeçš„å…·ä½“è¯­æ³•åœ¨æ­¤ä¸åšå±•å¼€ï¼Œè™½ç„¶è¿™ä¸ªä¾‹å­çœ‹èµ·æ¥éå¸¸ç®€å•æ˜“æ‡‚ï¼Œä½†çœŸå®åœºæ™¯ä¸­ï¼Œbitcodeçš„è¯­æ³•è¿œæ¯”è¿™ä¸ªå¤æ‚ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥ç›´æ¥é˜…è¯»<a href="https://llvm.org/docs/LangRef.html">LLVM Language Reference Manual</a>ã€‚</p>

<h2 id="0x03-enable-bitcode">0x03 Enable Bitcode</h2>

<p>åœ¨å¯¹bitcodeæœ‰äº†ä¸€ä¸ªç›´è§‚çš„è®¤è¯†ä¹‹åï¼Œå†æ¥çœ‹ä¸€ä¸‹Appleå›´ç»•bitcodeåšäº†ä»€ä¹ˆã€‚Xcodeä¸­å¯¹Enable Bitcodeè¿™ä¸ªé…ç½®çš„è§£é‡Šæ˜¯:</p>

<blockquote>
  <p>ä»¥ä¸‹æ‘˜è‡ªXcode Help</p>

  <p><a href="https://help.apple.com/xcode/mac/10.1/index.html?localePath=en.lproj#/itcaec37c2a6">https://help.apple.com/xcode/mac/10.1/index.html?localePath=en.lproj#/itcaec37c2a6</a></p>

</blockquote>

<h4 id="enable-bitcode-enable_bitcode">Enable Bitcode (ENABLE_BITCODE)</h4>
<blockquote>

  <p>Activating this setting indicates that the target or project should generate bitcode during compilation for platforms and architectures that support it. For Archive builds, bitcode will be generated in the linked binary for submission to the App Store. For other builds, the compiler and linker will check whether the code complies with the requirements for bitcode generation, but will not generate actual bitcode.</p>
</blockquote>

<p>å…·ä½“å±•å¼€ä¸€ä¸‹ï¼š</p>

<ul>
  <li>å¼€å¯æ­¤è®¾ç½®å°†ä¼šåœ¨æ”¯æŒçš„å¹³å°å’Œæ¶æ„ä¸­å¼€å¯bitcode
    <ul>
      <li>å½“å‰æ”¯æŒçš„å¹³å°ä¸»è¦æ˜¯iPhoneOS(armv7/arm64)ï¼ŒwatchOSç­‰</li>
      <li>æ³¨æ„ä¸åŒ…æ‹¬iPhoneSimulator(i386/x86_64)å’Œmacosï¼Œä¹Ÿå°±æ˜¯è¯´æ¨¡æ‹Ÿå™¨æ¶æ„ä¸‹ä¸ä¼šç¼–å‡ºbitcodeã€‚è¿™ä¸ªé™åˆ¶åªæ˜¯Xcodeè‡ªèº«çš„é™åˆ¶ï¼Œå¹¶éç¼–è¯‘å™¨çš„é™åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨ç¼–è¯‘å™¨æä¾›çš„å‘½ä»¤è¡Œå·¥å…·è‡ªè¡Œæ“ä½œä»ç„¶å¯ä»¥ç¼–è¯‘å‡ºè¿™äº›æ¶æ„ä¸‹çš„bitcodeï¼Œæœ¬æ–‡ä¸­çš„ç¤ºä¾‹å°±æ˜¯åŸºäºmacoså¹³å°/x86_64æ¶æ„ã€‚</li>
    </ul>
  </li>
  <li>è¿›è¡ŒArchiveæ—¶ï¼Œbitcodeä¼šè¢«åµŒå…¥åˆ°é“¾æ¥åçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œç”¨äºæäº¤ç»™App Store
    <ul>
      <li>Enable Bitcode è®¾ç½®ä¸º YES æ—¶ï¼Œä»ç¼–è¯‘æ—¥å¿—ä¸­å¯ä»¥çœ‹å‡ºï¼ŒArchiveæ—¶å¤šäº†ä¸€ä¸ªç¼–è¯‘å‚æ•° <code class="highlighter-rouge">-fembed-bitcode</code></li>
    </ul>
  </li>
  <li>è¿›è¡Œå…¶ä»–ç±»å‹çš„Build(éArchive)æ—¶ï¼Œç¼–è¯‘å™¨åªä¼šæ£€æŸ¥æ˜¯å¦æ»¡è¶³å¼€å¯bitcodeçš„æ¡ä»¶ï¼Œä½†å¹¶ä¸ä¼šçœŸæ­£ç”Ÿæˆbitcode
    <ul>
      <li>éArchiveç¼–è¯‘æ—¶ï¼ŒEnable Bitcode å°†ä¼šå¢åŠ ç¼–è¯‘å‚æ•° <code class="highlighter-rouge">-fembed-bitcode-marker</code>ï¼Œ åªæ˜¯åœ¨objectæ–‡ä»¶ä¸­åšäº†æ ‡è®°ï¼Œè¡¨æ˜<code class="highlighter-rouge">æˆ‘å¯ä»¥æœ‰bitcodeï¼Œä½†æ˜¯ç°åœ¨æš‚æ—¶æ²¡æœ‰å¸¦ä¸Šå®ƒ</code>ã€‚å› ä¸ºæœ¬åœ°ç¼–è¯‘è°ƒè¯•æ—¶å¹¶ä¸éœ€è¦bitcodeï¼Œåªæœ‰AppStoreéœ€è¦è¿™ç©æ„å„¿ï¼Œå»æ‰è¿™ä¸ªä¸å¿…è¦çš„æ­¥éª¤ï¼Œä¼šåŠ å¿«ç¼–è¯‘é€Ÿåº¦ã€‚</li>
      <li>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ‰çš„åŒå­¦åœ¨å¼€å‘SDKæ—¶ï¼Œæ˜æ˜å¼€å¯äº†Enable Bitcodeï¼Œäº¤ç»™å®¢æˆ·åå®¢æˆ·å´è¯´ï¼šä½ çš„sdké‡Œæ²¡æœ‰bitcodeï¼Œå› ä¸ºä½ æ²¡æœ‰ä½¿ç”¨Archiveæ–¹å¼æ‰“åŒ…ã€‚</li>
      <li>å½“ç„¶ï¼Œä½ å¯ä»¥å°† Enable Bitcode è®¾ç½®ä¸ºNOï¼Œ ç„¶ååœ¨Other Compiler Flags å’Œ Other Linker Flags ä¸­æ‰‹åŠ¨ä¸ºçœŸæœºæ¶æ„æ·»åŠ <code class="highlighter-rouge">-fembed-bitcode</code> å‚æ•°ï¼Œè¿™æ ·ä»»ä½•ç±»å‹çš„Buildéƒ½ä¼šå¸¦ä¸Šbitcode</li>
    </ul>
  </li>
</ul>

<p>æ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ Enable Bitcode ä¹‹åï¼Œç¼–è¯‘å‡ºçš„æ–‡ä»¶å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–ï¼Œ ç›´æ¥åœ¨clangçš„å‚æ•°ä¸­æ·»åŠ  <code class="highlighter-rouge">-fembed-bitcode</code> å³å¯</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -fembed-bitcode -c test.c -o test_bitcode.o
</code></pre></div></div>

<p>ç¼–è¯‘ä¹‹åå¯ä»¥é€šè¿‡toolå·¥å…·æŸ¥çœ‹objectæ–‡ä»¶çš„ç»“æ„ï¼Œæ­¤æ—¶ä½ éœ€è¦å¯¹Mach-Oæ–‡ä»¶æœ‰ä¸€äº›åŸºæœ¬çš„äº†è§£</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ otool -l test_bitcode.o
# ä»¥ä¸‹ä¸ºotoolè¾“å‡ºèŠ‚é€‰
Section
  sectname __bitcode
   segname __LLVM
      addr 0x0000000000000040
      size 0x0000000000000b10
    offset 776
     align 2^4 (16)
    reloff 0
    nreloc 0
     flags 0x00000000
 reserved1 0
 reserved2 0
Section
  sectname __cmdline
   segname __LLVM
      addr 0x0000000000000b50
      size 0x0000000000000042
    offset 3608
     align 2^4 (16)
    reloff 0
    nreloc 0
     flags 0x00000000
 reserved1 0
 reserved2 0
</code></pre></div></div>

<p>æˆ–è€…ä½¿ç”¨MachOView</p>

<p><img src="http://xelz.info/assets/2018/machoview.png" alt="" /></p>

<p>å¯ä»¥å‘ç°ç”Ÿæˆçš„ object æ–‡ä»¶ä¸­å¤šäº†ä¸¤ä¸ª Sectionï¼Œåˆ†åˆ«æ˜¯ <code class="highlighter-rouge">__LLVM,__bitcode</code> å’Œ <code class="highlighter-rouge">__LLVM,__cmdline</code>ï¼Œå¹¶ä¸”otoolçš„è¾“å‡ºä¸­ç»™å‡ºäº†è¿™ä¸¤ä¸ªsectionåœ¨objectæ–‡ä»¶ä¸­çš„åç§»å’Œå¤§å°ï¼Œé€šè¿‡ <code class="highlighter-rouge">dd</code> å‘½ä»¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†è¿™ä¸¤ä¸ªSectionæå–å‡ºæ¥</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dd bs=1 skip=776 count=0x0000000000000b10 if=test_bitcode.o of=test_bitcode.o.bc
2832+0 records in
2832+0 records out
2832 bytes transferred in 0.017339 secs (163331 bytes/sec)
$ dd bs=1 skip=3608 count=0x0000000000000042 if=test_bitcode.o of=test_bitcode.o.cmdline
66+0 records in
66+0 records out
66 bytes transferred in 0.001312 secs (50304 bytes/sec)
</code></pre></div></div>

<p>è¿˜æœ‰ä¸€ç§æ›´ä¾¿æ·çš„æ–¹å¼ï¼ŒXcode æä¾›çš„ <code class="highlighter-rouge">segedit</code> å‘½ä»¤å¯ä»¥ç›´æ¥å°†æŒ‡å®šçš„Sectionå¯¼å‡ºï¼Œåªéœ€è¦ç»™å®šSectionçš„åå­—ï¼Œå’Œä¸Šé¢çš„å‘½ä»¤æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œå¹¶ä¸”æ›´ä¸ºæ–¹ä¾¿</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ segedit -extract __LLVM __bitcode test_bitcode.o.bc \
          -extract __LLVM __cmdline test_bitcode.o.cmdline \
          test_bitcode.o
</code></pre></div></div>

<p>è§‚å¯Ÿä¸€ä¸‹å¯¼å‡ºçš„æ–‡ä»¶</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ file test_bitcode.o.bc
test_bitcode.o.bc: LLVM bitcode, wrapper x86_64
$ cat test_bitcode.o.cmdline | tr '\0' ' '
-triple x86_64-apple-macosx10.14.0 -emit-obj -disable-llvm-passes
$ md5 test.bc test_bitcode.o.bc
MD5 (test.bc) = 1592ed7db86742184a559e86cb9d1355
MD5 (test_bitcode.o.bc) = 9901ac8db63be30dafc19c2f06b0cae8
</code></pre></div></div>

<p>ä¸éš¾å¾—å‡ºç»“è®ºï¼š</p>

<ul>
  <li>objectæ–‡ä»¶ä¸­åµŒå…¥çš„<code class="highlighter-rouge">__LLVM,__bitcode</code> æ­£æ˜¯å®Œæ•´çš„ï¼Œæœªç»ä»»ä½•åŠ å¯†æˆ–è€…å‹ç¼©çš„bitcodeæ–‡ä»¶ï¼Œé€šè¿‡ <code class="highlighter-rouge">-fembed-bitcode</code> å‚æ•°ï¼ŒclangæŠŠå¯¹åº”çš„bitcodeæ–‡ä»¶æ•´ä¸ªåµŒå…¥åˆ°äº†objectæ–‡ä»¶ä¸­</li>
  <li><code class="highlighter-rouge">__LLVM,__cmdline</code> æ˜¯ç¼–è¯‘è¿™ä¸ªæ–‡ä»¶æ‰€ç”¨åˆ°çš„å‚æ•°ï¼Œå¦‚æœè¦é€šè¿‡å¯¼å‡ºçš„bitcodeé‡æ–°ç¼–è¯‘è¿™ä¸ªobjectæ–‡ä»¶ï¼Œå¿…é¡»å¸¦ä¸Šè¿™äº›å‚æ•°
    <ul>
      <li>å¯¼å‡ºçš„å‚æ•°æ˜¯<code class="highlighter-rouge">cc1</code> ä¹Ÿå°±æ˜¯clangä¸­çœŸæ­£â€å‰ç«¯â€éƒ¨åˆ†çš„å‚æ•°(clangå‘½ä»¤å…¶å®æ˜¯æ•´åˆäº†å„ä¸ªç¯èŠ‚ï¼Œæ‰€ä»¥clangä¸€ä¸ªå‘½ä»¤å¯ä»¥ä»æºä»£ç ç¼–å‡ºå¯æ‰§è¡Œæ–‡ä»¶)ï¼Œæ‰€ä»¥ç¼–è¯‘æ—¶è¦å¸¦ä¸Š<code class="highlighter-rouge">-cc1</code></li>
    </ul>
  </li>
  <li>å¯¼å‡ºçš„bitcodeæ–‡ä»¶ä¼¼ä¹å’Œç›´æ¥ç¼–è¯‘çš„bitcodeä¸ä¸€æ ·ï¼Œå…ˆç•™ä¸ªç–‘é—®ï¼Œåé¢å†ç ”ç©¶</li>
</ul>

<p>é¦–å…ˆï¼Œ æ¥æµ‹è¯•ä¸€ä¸‹å¯¼å‡ºçš„bitcodeæ–‡ä»¶ç»“åˆcmdlineèƒ½å¦ç¼–è¯‘å‡ºæ­£å¸¸çš„object:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -cc1 -triple x86_64-apple-macosx10.14.0 -emit-obj -disable-llvm-passes test_bitcode.o.bc -o test_rebuild.o
$ file test_rebuild.o
test_rebuild.o: Mach-O 64-bit object x86_64
$ md5 test.o test_rebuild.o
MD5 (test.o) = 70ea3a520c26df84d1f7ca552e8e6620
MD5 (test_rebuild.o) = 70ea3a520c26df84d1f7ca552e8e6620
</code></pre></div></div>

<p>æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå¹¶ä¸”é€šè¿‡å†…åµŒçš„bitcodeç¼–è¯‘å‡ºçš„objectæ–‡ä»¶ä¸ç›´æ¥ä»æºä»£ç ç¼–è¯‘å‡ºæ¥çš„objectå®Œå…¨ä¸€æ ·ï¼é¹…å¦¹å­å˜¤~ï¼</p>

<p>å›åˆ°é—ç•™çš„é—®é¢˜ï¼šä¸ºä»€ä¹ˆå¯¼å‡ºçš„bitcodeæ–‡ä»¶å’Œç›´æ¥ç¼–è¯‘çš„bitcodeä¼šä¸ä¸€æ ·ï¼Ÿæ˜æ˜ç¼–å‡ºçš„objectéƒ½æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼è¿™æ˜¯å› ä¸ºäºŒè¿›åˆ¶çš„bitcodeæ–‡ä»¶ä¸­è¿˜ä¿å­˜äº†ä¸€äº›ä¸å®é™…ä»£ç æ— å…³çš„metaä¿¡æ¯ã€‚å¦‚æœèƒ½å°†bitcodeè½¬æ¢ä¸ºæ–‡æœ¬æ ¼å¼ï¼Œå°†èƒ½æ›´ç›´è§‚åœ°è¿›è¡Œå¯¹æ¯”ã€‚å‰é¢å·²ç»æåˆ°ï¼Œxcodeä¸­å¹¶æ²¡æœ‰é™„å¸¦è½¬æ¢å·¥å…·ï¼Œä½†æ˜¯æˆ‘ä»¬ä¾ç„¶å¯ä»¥é€šè¿‡clangæ¥å®Œæˆè¿™ä¸€æ“ä½œï¼Œè¿˜è®°å¾—å‰é¢ç”¨è¿‡çš„ <code class="highlighter-rouge">-emit-llvm -S</code> å—ï¼Ÿ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -emit-llvm -S test_bitcode.o.bc -o test_bitcode.o.ll
</code></pre></div></div>

<p>ç¥å¥‡å§ï¼Ÿè¾“å…¥è™½ç„¶å·²ç»æ˜¯bitcodeäº†ï¼Œå¹¶éæºä»£ç ï¼Œä½†æ˜¯clangä¹Ÿèƒ½â€ç¼–è¯‘â€å‡ºLLVM Assemblyã€‚å…¶å®clangå†…éƒ¨æ˜¯å…ˆå°†è¾“å…¥çš„æ–‡ä»¶è½¬æ¢æˆModuleå¯¹è±¡ï¼Œç„¶åå†æ‰§è¡Œå¯¹åº”çš„å¤„ç†ï¼š</p>

<ul>
  <li>å¦‚æœè¾“å…¥æ˜¯æºä»£ç ï¼Œä¼šå…ˆè¿›è¡Œå‰ç«¯ç¼–è¯‘ï¼Œå¾—åˆ°ä¸€ä¸ªModule</li>
  <li>å¦‚æœè¾“å…¥æ˜¯bitcodeæˆ–è€…LLVM Assemblyï¼Œé‚£ä¹ˆç›´æ¥è¿›è¡Œparseæ“ä½œï¼Œå³å¯å¾—åˆ°Moduleå¯¹è±¡</li>
  <li>å¦‚æœè¾“å‡ºç±»å‹æ˜¯LLVM Assemblyï¼Œå°†Moduleå¯¹è±¡åºåˆ—åŒ–ä¸ºæ–‡æœ¬æ ¼å¼</li>
  <li>å¦‚æœè¾“å‡ºç±»å‹æ˜¯bitcodeï¼Œåˆ™å°†Moduleå¯¹è±¡åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ ¼å¼</li>
</ul>

<p>æ‰€ä»¥å®Œå…¨å¯ä»¥é€šè¿‡clangè¿›è¡Œbitcodeå’ŒLLVM Assemblyçš„ç›¸äº’è½¬æ¢ã€‚</p>

<p>ç°åœ¨ï¼Œå¯ä»¥å¯¹æ¯”ä¸€ä¸‹å‰åä¸¤æ¬¡ç”Ÿæˆçš„<code class="highlighter-rouge">.ll</code>æ–‡ä»¶:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ diff test_bitcode.o.ll test.ll
1c1
&lt; ; ModuleID = 'test_bitcode.o.bc'
---
&gt; ; ModuleID = 'test.c'
</code></pre></div></div>

<p>é™¤äº†ModuleIDï¼Œä¹Ÿå°±æ˜¯æ¥æºçš„æ–‡ä»¶åä»¥å¤–ï¼Œå…¶ä½™éƒ¨åˆ†å®Œå…¨ç›¸åŒï¼Œè¿™ä¹Ÿå°±è§£å†³äº†å‰é¢çš„ç–‘è™‘ã€‚</p>

<p>å†æ¥å›é¡¾ä¸€ä¸‹ï¼Œå‰æ–‡æåˆ°éArchiveç±»å‹çš„buildï¼Œæ¯”å¦‚ç›´æ¥<code class="highlighter-rouge">âŒ˜ + B</code>ï¼Œå³ä½¿å¼€å¯äº†bitcodeï¼Œä¹Ÿä¸ä¼šç¼–å‡ºbitcodeï¼Œé‚£ä¹ˆä¼šäº§ç”Ÿä»€ä¹ˆæ ·çš„æ–‡ä»¶å‘¢ï¼Ÿé€šè¿‡è§‚å¯Ÿç¼–è¯‘æ—¥å¿—å¯ä»¥çœ‹å‡ºxcodeåœ¨æ­¤æ—¶ä½¿ç”¨äº†<code class="highlighter-rouge">-fembed-bitcode-marker</code> è¿™æ ·ä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang -fembed-bitcode-marker -c test.c -o test_bitcode_marker.o
$ otool -l test_bitcode_marker.o
# ä»¥ä¸‹ä¸ºotoolè¾“å‡ºèŠ‚é€‰
Section
  sectname __bitcode
   segname __LLVM
      addr 0x0000000000000039
      size 0x0000000000000001    # åªæœ‰ä¸€ä¸ªå­—èŠ‚
    offset 769
     align 2^0 (1)
    reloff 0
    nreloc 0
     flags 0x00000000
$ objdump -s -section=__bitcode test_bitcode_marker.o
Contents of section __bitcode:
 0039 00                                   . # åªæœ‰ä¸€ä¸ªå­—èŠ‚ 0x00
</code></pre></div></div>

<p>è¿™æ ·çš„æ–¹å¼ç¼–è¯‘å‡ºçš„æ–‡ä»¶ç»“æ„ä¸<code class="highlighter-rouge">-fembed-bitcode</code> çš„ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ <code class="highlighter-rouge">__LLVM,__bitcode</code> å’Œ <code class="highlighter-rouge">__LLVM,__cmdline</code> çš„å†…å®¹å¹¶æ²¡æœ‰å°†å®é™…çš„bitcodeæ–‡ä»¶å’Œç¼–è¯‘å‚æ•°åµŒå…¥è¿›æ¥ï¼Œå–è€Œä»£ä¹‹çš„ä¸€ä¸ªå­—èŠ‚çš„å ä½ç¬¦ <code class="highlighter-rouge">0x00</code></p>

<h2 id="0x04-bitcode-bundle">0x04 Bitcode Bundle</h2>

<p>å·²ç»ææ¸…æ¥šäº†bitcodeæ˜¯å¦‚ä½•åµŒå…¥åœ¨objectæ–‡ä»¶é‡Œçš„ï¼Œä½†æ˜¯objectåªæ˜¯ç¼–è¯‘è¿‡ç¨‹çš„ä¸­é—´äº§ç‰©ï¼ŒçœŸæ­£è¿è¡Œçš„ä»£ç æ˜¯å¤šä¸ªobjectæ–‡ä»¶ç»è¿‡é“¾æ¥ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥è¦åˆ†æä¸‹objectä¸­åµŒå…¥çš„bitcodeæ˜¯å¦‚ä½•è¢«é“¾æ¥çš„ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ clang test.o -o test # é“¾æ¥åŸå§‹object
$ ./test
hello, world.
$ clang -fembed-bitcode test_bitcode.o -o test_bitcode # é“¾æ¥å¸¦bitcodeçš„object
$ ./test_bitcode
hello, world.
$ otool -l test_bitcode
# ä»¥ä¸‹ä¸ºotoolè¾“å‡ºèŠ‚é€‰
Section
  sectname __bundle
   segname __LLVM
      addr 0x0000000100002000
      size 0x0000000000001261
    offset 8192
     align 2^0 (1)
    reloff 0
    nreloc 0
     flags 0x00000000
 reserved1 0
 reserved2 0
</code></pre></div></div>

<p>objectä¸­çš„ <code class="highlighter-rouge">__LLVM,__bitcode</code> å’Œ <code class="highlighter-rouge">__LLVM,__cmdline</code> ä¸è§äº†ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä¸€ä¸ª <code class="highlighter-rouge">__LLVM,__bundle</code> çš„Sectionï¼Œ é€šè¿‡åå­—å¯ä»¥åŸºæœ¬æ¨æ–­å‡ºobjectä¸­çš„bitcodeè¢«æ‰“åŒ…åœ¨äº†ä¸€èµ·ï¼ŒæŠŠå®ƒä»å¯æ‰§è¡Œæ–‡ä»¶ä¸­dumpå‡ºæ¥ä¸€æ¢ç©¶ç«Ÿï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ segedit -extract __LLVM __bundle bundle test_bitcode
$ file bundle
bundle: xar archive version 1, SHA-1 checksum
</code></pre></div></div>

<p>è¿™ä¸ªbundleæ–‡ä»¶æ˜¯ä¸€ä¸ª<code class="highlighter-rouge">xar</code>æ ¼å¼çš„å‹ç¼©åŒ…ï¼Œxaræ ¼å¼åŒ…å«äº†ä¸€ä¸ª<code class="highlighter-rouge">xml</code>æ ¼å¼çš„æ–‡ä»¶å¤´(TOC)ï¼Œé‡Œé¢ç”¨äºå­˜æ”¾å„ç§æ–‡ä»¶çš„åŸºæœ¬å±æ€§ä»¥åŠä¸€äº›é™„åŠ é™„åŠ ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡xarå‘½ä»¤æŸ¥çœ‹å¹¶è§£å‹</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ xar -d toc.xml -f bundle # å¯¼å‡ºæ–‡ä»¶å¤´
$ mkdir bundle.extract
$ xar -x -C bundle.extract -f bundle # è§£å‹æ–‡ä»¶
$ ls bundle.extract
1
$ file bundle.extract/1
bundle.extract/1: LLVM bitcode, wrapper x86_64
$ md5 bundle.extract/1 test_bitcode.o.bc
MD5 (bundle.extract/1) = 9901ac8db63be30dafc19c2f06b0cae8
MD5 (test_bitcode.o.bc) = 9901ac8db63be30dafc19c2f06b0cae8
</code></pre></div></div>

<p>æŸ¥çœ‹å¯¼å‡ºçš„toc.xml</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;xar&gt;</span>
 <span class="nt">&lt;subdoc</span> <span class="na">subdoc_name=</span><span class="s">"Ld"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;architecture&gt;</span>x86_64<span class="nt">&lt;/architecture&gt;</span>
  <span class="nt">&lt;platform&gt;</span>macOS<span class="nt">&lt;/platform&gt;</span>
  <span class="nt">&lt;sdkversion&gt;</span>10.14.0<span class="nt">&lt;/sdkversion&gt;</span>
  <span class="nt">&lt;dylibs&gt;</span>
   <span class="nt">&lt;lib&gt;</span>{SDKPATH}/usr/lib/libSystem.B.dylib<span class="nt">&lt;/lib&gt;</span>
  <span class="nt">&lt;/dylibs&gt;</span>
  <span class="nt">&lt;link-options&gt;</span>
   <span class="nt">&lt;option&gt;</span>-execute<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;option&gt;</span>-macosx_version_min<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;option&gt;</span>10.14.0<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;option&gt;</span>-e<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;option&gt;</span>_main<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;option&gt;</span>-executable_path<span class="nt">&lt;/option&gt;</span>
   <span class="nt">&lt;option&gt;</span>test<span class="nt">&lt;/option&gt;</span>
  <span class="nt">&lt;/link-options&gt;</span>
 <span class="nt">&lt;/subdoc&gt;</span>
 <span class="nt">&lt;toc&gt;</span>
  <span class="nt">&lt;checksum</span> <span class="na">style=</span><span class="s">"sha1"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;size&gt;</span>20<span class="nt">&lt;/size&gt;</span>
   <span class="nt">&lt;offset&gt;</span>0<span class="nt">&lt;/offset&gt;</span>
  <span class="nt">&lt;/checksum&gt;</span>
  <span class="nt">&lt;creation-time&gt;</span>2018-12-19T12:07:24<span class="nt">&lt;/creation-time&gt;</span>
  <span class="nt">&lt;file</span> <span class="na">id=</span><span class="s">"1"</span><span class="nt">&gt;</span>
   <span class="nt">&lt;name&gt;</span>1<span class="nt">&lt;/name&gt;</span>
   <span class="nt">&lt;type&gt;</span>file<span class="nt">&lt;/type&gt;</span>
   <span class="nt">&lt;data&gt;</span>
    <span class="nt">&lt;archived-checksum</span> <span class="na">style=</span><span class="s">"sha1"</span><span class="nt">&gt;</span>56346f644ab01200e0ad56eaefb9346a863cb473<span class="nt">&lt;/archived-checksum&gt;</span>
    <span class="nt">&lt;extracted-checksum</span> <span class="na">style=</span><span class="s">"sha1"</span><span class="nt">&gt;</span>56346f644ab01200e0ad56eaefb9346a863cb473<span class="nt">&lt;/extracted-checksum&gt;</span>
    <span class="nt">&lt;size&gt;</span>2832<span class="nt">&lt;/size&gt;</span>
    <span class="nt">&lt;offset&gt;</span>20<span class="nt">&lt;/offset&gt;</span>
    <span class="nt">&lt;encoding</span> <span class="na">style=</span><span class="s">"application/octet-stream"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;length&gt;</span>2832<span class="nt">&lt;/length&gt;</span>
   <span class="nt">&lt;/data&gt;</span>
   <span class="nt">&lt;file-type&gt;</span>Bitcode<span class="nt">&lt;/file-type&gt;</span>
   <span class="nt">&lt;clang&gt;</span>
    <span class="nt">&lt;cmd&gt;</span>-triple<span class="nt">&lt;/cmd&gt;</span>
    <span class="nt">&lt;cmd&gt;</span>x86_64-apple-macosx10.14.0<span class="nt">&lt;/cmd&gt;</span>
    <span class="nt">&lt;cmd&gt;</span>-emit-obj<span class="nt">&lt;/cmd&gt;</span>
    <span class="nt">&lt;cmd&gt;</span>-disable-llvm-passes<span class="nt">&lt;/cmd&gt;</span>
   <span class="nt">&lt;/clang&gt;</span>
  <span class="nt">&lt;/file&gt;</span>
 <span class="nt">&lt;/toc&gt;</span>
<span class="nt">&lt;/xar&gt;</span>
</code></pre></div></div>

<p>headerçš„ç»“æ„éå¸¸æ¸…æ™°ï¼Œå†…å®¹åŸºæœ¬åŒ…å«è¿™äº›ï¼š</p>

<ul>
  <li>ld çš„åŸºæœ¬å‚æ•°ï¼Œæˆ‘ä»¬é“¾æ¥æ—¶ä½¿ç”¨çš„æ˜¯clangï¼Œå®é™…ä¸Šclangå†…éƒ¨è°ƒç”¨äº†ldï¼Œè¿™é‡Œè®°å½•çš„æ˜¯ldçš„å‚æ•°
    <ul>
      <li>version: bitcode bundle çš„ç‰ˆæœ¬å·</li>
      <li>architecture: ç›®æ ‡æ¶æ„</li>
      <li>platform: ç›®æ ‡å¹³å°</li>
      <li>sdkversion: sdkç‰ˆæœ¬</li>
      <li>dylibs: é“¾æ¥çš„åŠ¨æ€åº“</li>
      <li>link-options: å…¶ä»–é“¾æ¥å‚æ•°</li>
    </ul>
  </li>
  <li>æ–‡ä»¶ç›®å½•
    <ul>
      <li>checksumç±»å‹</li>
      <li>åˆ›å»ºæ—¶é—´</li>
      <li>æ¯ä¸ªæ–‡ä»¶çš„ä¿¡æ¯
        <ul>
          <li>æ–‡ä»¶åï¼Œè¿™é‡Œå¹¶éåŸå§‹æ–‡ä»¶åï¼Œè€Œæ˜¯æŒ‰ç…§é“¾æ¥æ—¶è¾“å…¥çš„é¡ºåºè¢«é‡å‘½åä¸ºæ•°å­—åºå·</li>
          <li>åŸºæœ¬å±æ€§ï¼ŒåŒ…æ‹¬checksumã€åç§»ã€å¤§å°ç­‰</li>
          <li>æ–‡ä»¶ç±»å‹ï¼Œä¸€èˆ¬æ˜¯Bitcodeï¼Œè¿˜æœ‰ä¸¤ç§ç‰¹æ®Šç±»å‹ï¼ŒObjectä»¥åŠBundleï¼Œè¿™é‡Œå–ä¸ªå…³å­ï¼Œå¤§å®¶æœ‰å…´è¶£å¯å·²è‡ªè¡Œç ”ç©¶(æƒ³æƒ³å¦‚æœä¸€ä¸ªæºä»£ç æ–‡ä»¶æ˜¯.sæ ¼å¼ï¼Œè¦å¦‚ä½•æ”¯æŒbitcode)</li>
          <li>ç¼–è¯‘å™¨ç±»å‹(clang/swift)åŠç¼–è¯‘å‚æ•°ï¼Œè¿™éƒ¨åˆ†å°±æ˜¯objectæ–‡ä»¶ä¸­ <code class="highlighter-rouge">__LLVM,__cmdline</code> çš„å†…å®¹</li>
        </ul>
      </li>
      <li>ä¸‹ä¸€ä¸ªæ–‡ä»¶çš„ä¿¡æ¯(å¦‚æœ‰)</li>
      <li>é‡å¤</li>
    </ul>
  </li>
</ul>

<p>ä»bundleä¸­è§£å‹å‡ºæ¥çš„æ–‡ä»¶ï¼Œå°±æ˜¯objectä¸­åµŒå…¥çš„bitcodeï¼Œé€šè¿‡MD5å¯¹æ¯”å¯ä»¥çœ‹å‡ºé“¾æ¥æ—¶å¯¹bitcodeæ–‡ä»¶è‡ªèº«æ²¡æœ‰åšä»»ä½•å¤„ç†ã€‚å¯ä»¥æ³¨æ„åˆ°ï¼Œç”¨äºç¼–è¯‘å„ä¸ªbitcodeæ–‡ä»¶çš„å‚æ•°(cmdline)è¢«æ”¾è¿›äº†TOCä¸­æ–‡ä»¶æè¿°çš„åŒºåŸŸï¼Œè€ŒTOCä¸­å¤šå‡ºäº†ä¸€ä¸ªéƒ¨åˆ†ç”¨äºå­˜æ”¾é“¾æ¥æ—¶æ‰€éœ€è¦çš„ä¿¡æ¯å’Œå¿…è¦çš„å‚æ•°ï¼Œæœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œ æˆ‘ä»¬ä¸éš¾é€šè¿‡bitcodeé‡æ–°ç¼–è¯‘ï¼Œå¹¶é“¾æ¥å‡ºä¸€ä¸ªæ–°çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># é¦–å…ˆæ ¹æ®æ–‡ä»¶ç›®å½•ï¼Œå°†è§£å‹å‡ºçš„æ¯ä¸€ä¸ªbitcodeæ–‡ä»¶ç¼–è¯‘ä¸ºobject
$ clang -cc1 -triple x86_64-apple-macosx10.14.0 -emit-obj -disable-llvm-passes bundle.extract/1 -o bundle.extract/1.o -x ir
# ç”±äºè§£å‹å‡ºçš„æ–‡ä»¶æ²¡æœ‰åç¼€åï¼Œclangæ— æ³•åˆ¤æ–­è¾“å…¥æ–‡ä»¶çš„æ ¼å¼ï¼Œå› æ­¤ä½¿ç”¨ -x ir å¼ºåˆ¶æŒ‡å®šè¾“å…¥æ–‡ä»¶ä¸ºiræ ¼å¼
# ä¹Ÿå¯ä»¥å°†å…¶é‡å‘½åä¸º1.bcï¼Œè¿™æ ·å°±ä¸ç”¨æŒ‡å®š-x ir

# æ ¹æ®toc.xmlä¸­æä¾›çš„é“¾æ¥å‚æ•°ï¼Œå°†æ‰€æœ‰objectæ–‡ä»¶é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œæœ¬ä¾‹ä¸­åªæœ‰ä¸€ä¸ªæ–‡ä»¶
$ ld \
    -arch x86_64 `# architecture` \
    -syslibroot `xcrun --show-sdk-path --sdk macosx` `# platform` \
    -sdk_version 10.14.0 `# sdkversion` \
    -lSystem `# dylibs` \
    -execute `# link-options` \
    -macosx_version_min 10.14.0 `# link-options` \
    -e _main `# link-options` \
    -executable_path test `# link-options` \
    -o test_rebuild `# è¾“å‡ºæ–‡ä»¶` \
    bundle.extract/1.o `# è¾“å…¥æ–‡ä»¶`
$ ./test_rebuild
hello, world.
$ md5 test_rebuild test
MD5 (test_rebuild) = f4786288582decf2b8a1accb1aaa4a3c
MD5 (test) = f4786288582decf2b8a1accb1aaa4a3c
</code></pre></div></div>

<p>çœ‹ï¼æˆ‘ä»¬æˆåŠŸåˆ©ç”¨bitcodeé‡æ–°ç¼–äº†ä¸€ä»½ä¸€æ¨¡ä¸€æ ·çš„å¯æ‰§è¡Œæ–‡ä»¶å‡ºæ¥ã€‚</p>

<p>ç°åœ¨å¯ä»¥ç†è§£ï¼Œä¸ºä»€ä¹ˆè‹¹æœè¦å¼ºæ¨bitcodeäº†å§ï¼Ÿå¼€å‘è€…æŠŠbitcodeæäº¤åˆ°App Store Connectä¹‹åï¼Œå¦‚æœè‹¹æœå‘å¸ƒäº†ä½¿ç”¨æ–°èŠ¯ç‰‡çš„iPhoneï¼Œæ”¯æŒæ›´é«˜æ•ˆçš„æŒ‡ä»¤ï¼Œå¼€å‘è€…ä¸éœ€è¦åšä»»ä½•æ“ä½œï¼ŒApp Store Connectè‡ªå·±å°±å¯ä»¥ç¼–è¯‘å‡ºé’ˆå¯¹æ–°äº§å“ä¼˜åŒ–è¿‡çš„appå¹¶é€šè¿‡App Storeåˆ†å‘ç»™ç”¨æˆ·ï¼Œä¸éœ€è¦å¼€å‘è€…è‡ªå·±é‡æ–°æ‰“åŒ…ä¸Šæ¶ï¼Œè¿™æ ·ä¸€æ¥è‹¹æœçš„Storeç”Ÿæ€å°±ä¸éœ€è¦ä¾èµ–å¼€å‘è€…çš„ç§¯ææ€§äº†ã€‚</p>

<h2 id="0x05-ä½¿ç”¨bitcodeå¯¼å‡ºipa">0x05 ä½¿ç”¨Bitcodeå¯¼å‡ºipa</h2>

<p>å‰é¢å·²ç»æåˆ°ï¼Œå¦‚æœè¦ä»¥bitcodeæ–¹å¼ä¸Šä¼ appï¼Œå¿…é¡»åœ¨å¼€å¯bitcodeçš„çŠ¶æ€ä¸‹ï¼Œè¿›è¡ŒArchiveæ‰“åŒ…ï¼Œæ‰ä¼šå¾—åˆ°å¸¦æœ‰bitcodeçš„appã€‚å¤§éƒ¨åˆ†appéƒ½ä¼šä¾èµ–ä¸€å †ç¬¬ä¸‰æ–¹sdkï¼Œå¦‚æœæ­¤æ—¶é¡¹ç›®é‡Œä¾èµ–çš„æŸä¸€ä¸ªæˆ–è€…å‡ ä¸ªsdkæ²¡æœ‰å¼€å¯bitcodeï¼Œé‚£ä¹ˆå¾ˆé—æ†¾ï¼ŒXcodeä¼šæ‹’ç»ç¼–è¯‘å¹¶ç»™å‡ºç±»ä¼¼è¿™æ ·çš„æç¤ºï¼š</p>

<blockquote>
  <p>ld: â€˜name_of_the_library_or_frameworkâ€™ does not contain bitcode. You must rebuild it with bitcode enabled (Xcode setting ENABLE_BITCODE), obtain an updated library from the vendor, or disable bitcode for this target.</p>

  <p>ld: bitcode bundle could not be generated because â€˜name_of_the_library_or_frameworkâ€™ was built without full bitcode.</p>
</blockquote>

<p>ç¬¬ä¸€ç§æç¤ºè¡¨ç¤ºè¿™ä¸ªç¬¬ä¸‰æ–¹åº“å®Œå…¨æ²¡æœ‰å¼€å¯bitcodeï¼Œè€Œç¬¬äºŒç§æç¤ºè¡¨ç¤ºå®ƒåªæœ‰bitcode-markerï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„å¼€å‘è€…è™½ç„¶åœ¨å·¥ç¨‹é…ç½®ä¸­è®¾ç½®äº† Enable Bitcode ä¸º YESï¼Œä½†å¹¶æ²¡æœ‰ä»¥Archiveæ–¹å¼ç¼–è¯‘ï¼Œå¯èƒ½åªæ˜¯âŒ˜ + Bï¼Œç„¶åé¡ºæ‰‹æŠŠProductsæ‹·è´å‡ºæ¥äº¤ä»˜äº†ã€‚</p>

<p>é‡åˆ°è¿™ç§é—®é¢˜ï¼Œä¹Ÿéœ€è¦åˆ†ä¸¤ç§æƒ…å†µæ¥çœ‹ï¼š</p>

<ul>
  <li>å¦‚æœè¿™ä¸ªåº“æ˜¯åœ¨æœ¬åœ°ç¼–è¯‘çš„ï¼Œ æ¯”å¦‚è‡ªå·±é¡¹ç›®é‡Œæˆ–è€…å­é¡¹ç›®é‡Œçš„targetï¼Œæˆ–è€…é€šè¿‡Podså¼•å…¥äº†æºä»£ç ï¼Œé‚£ä¹ˆè¿™ä¸ªtargetä¸€å®šæ²¡æœ‰å¼€å¯bitcodeï¼Œåœ¨å·¥ç¨‹ä¸­æ‰¾åˆ°è¿™ä¸ªtargetçš„Build SettingsæŠŠEnable Bitcodeç½®ä¸ºYESå³å¯</li>
  <li>ä½†å¦‚æœæ˜¯ç¬¬ä¸‰æ–¹æä¾›çš„äºŒè¿›åˆ¶åº“æ–‡ä»¶ï¼Œåˆ™éœ€è¦è”ç³»sdkçš„æä¾›æ–¹ç¡®è®¤æ˜¯å¦èƒ½æä¾›å¸¦bitcodeçš„ç‰ˆæœ¬ï¼Œå¦åˆ™åªèƒ½å…³é—­è‡ªå·±é¡¹ç›®ä¸­çš„bitcodeã€‚è¿™ä¹Ÿæ˜¯bitcodeæ—¶è‡³ä»Šæ—¥éƒ½æ²¡æœ‰å¾—åˆ°å¤§é¢ç§¯åº”ç”¨çš„æœ€å¤§éšœé˜»ç¢ã€‚</li>
</ul>

<p>å½“ä½¿ç”¨Archiveæ–¹å¼æ‰“åŒ…å‡ºå¸¦æœ‰bitcodeçš„åŒ…æ—¶ï¼Œä½ ä¼šå‘ç°è¿™ä¸ªåŒ…é‡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶æ¯”æ²¡æœ‰å¼€å¯bitcodeæ—¶å¤§å‡ºäº†è®¸å¤šï¼Œå¤šå‡ºæ¥çš„å…¶å®å°±æ˜¯bitcodeçš„ä½“ç§¯ï¼Œå¹¶ä¸”bitcodeçš„ä½“ç§¯ï¼Œä¸€èˆ¬è¦æ¯”äºŒè¿›åˆ¶æ–‡ä»¶æœ¬èº«è¿˜è¦å¤§å‡ºè®¸å¤š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ls -al test.o test_bitcode.o test.bc
-rw-r--r--  1 xelz  staff  2848 12 19 18:42 test.bc
-rw-r--r--@ 1 xelz  staff   784 12 19 18:24 test.o
-rw-r--r--@ 1 xelz  staff  3920 12 19 18:59 test_bitcode.o
$ ls -al test test_bitcode
-rwxr-xr-x@ 1 xelz  staff   8432 12 19 21:38 test
-rwxr-xr-x@ 1 xelz  staff  16624 12 19 20:50 test_bitcode
</code></pre></div></div>

<p>å½“ç„¶ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¹¶ä¸ä¼šå¯¼è‡´ç”¨æˆ·ä¸‹è½½åˆ°çš„APPå˜å¤§ï¼Œå› ä¸ºç”¨æˆ·ä¸‹è½½åˆ°çš„ä»£ç ä¸­åªä¼šæœ‰æœºå™¨ç ï¼Œä¸ä¼šåŒ…å«bitcodeã€‚æœ‰çš„é¡¹ç›®å¼€å¯bitcodeä¹‹åä¼šå‘ç°äºŒè¿›åˆ¶çš„ä½“ç§¯å¢å¤§åˆ°è¶…å‡ºäº†è‹¹æœå¯¹<a href="https://help.apple.com/app-store-connect/#/dev611e0a21f">äºŒè¿›åˆ¶ä½“ç§¯çš„é™åˆ¶</a>ï¼Œä½†æ˜¯å®Œå…¨ä¸ç”¨æ‹…å¿ƒï¼Œè‹¹æœçš„é™åˆ¶åªæ˜¯é’ˆå¯¹<code class="highlighter-rouge">__TEXT</code> æ®µï¼Œè€ŒåµŒå…¥çš„bitcodeæ˜¯å­˜å‚¨åœ¨å•ç‹¬çš„<code class="highlighter-rouge">__LLVM</code> æ®µï¼Œä¸åœ¨è‹¹æœçš„é™åˆ¶èŒƒå›´å†…ã€‚</p>

<p>æ‰“åŒ…å‡ºå¸¦æœ‰bitcodeçš„xcarchiveä¹‹åï¼Œå¯ä»¥å¯¼å‡ºDevelopment IPAè¿›è¡Œä¸Šçº¿å‰çš„æœ€ç»ˆæµ‹è¯•ï¼Œæˆ–è€…ä¸Šä¼ åˆ°App Store Connectè¿›è¡Œæå®¡ä¸Šæ¶ã€‚è¿›è¡Œæ­¤ç±»æ“ä½œæ—¶ä¼šå‘ç°Xcode Organizerä¸­å¤šå‡ºäº†bitcodeç›¸å…³çš„é€‰é¡¹ï¼š</p>

<ul>
  <li>å¯¼å‡ºDevelopmentç‰ˆæœ¬æ—¶ï¼Œå¯ä»¥å‹¾é€‰<code class="highlighter-rouge">Rebuild from Bitcode</code>ï¼Œè¿™æ—¶å¯¼å‡ºä¼šå˜çš„å¾ˆæ…¢ï¼Œå› ä¸ºXcodeåœ¨åå°é€šè¿‡bitcodeé‡æ–°ç¼–è¯‘ä»£ç ï¼Œè¿™æ ·å¯¼å‡ºçš„ipaæœ€æ¥è¿‘æœ€ç»ˆç”¨æˆ·ä»AppStoreä¸‹è½½çš„ç‰ˆæœ¬ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯æ¥è¿‘å‘¢ï¼Œå› ä¸ºè‹¹æœä½¿ç”¨çš„ç¼–è¯‘å™¨ç‰ˆæœ¬å¾ˆå¯èƒ½å’Œæœ¬åœ°Xcodeä¸ä¸€æ ·ï¼Œå¹¶ä¸”è‹¹æœå¯èƒ½åœ¨ç¼–è¯‘æ—¶å¢åŠ é¢å¤–çš„ä¼˜åŒ–æ­¥éª¤ï¼Œè¿™äº›éƒ½ä¼šå¯¼è‡´è‹¹æœç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶è·Ÿæœ¬åœ°ç¼–è¯‘çš„ç‰ˆæœ¬äº§ç”Ÿå·®å¼‚ã€‚è€Œå¦‚æœä¸å‹¾é€‰æ­¤é€‰é¡¹ï¼Œåˆ™ä¼šç›´æ¥ä½¿ç”¨Archiveæ—¶ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶ä»£ç ï¼Œå¹¶æŠŠbitcodeä»äºŒè¿›åˆ¶ä¸­å»é™¤ä»¥å‡å°ä½“ç§¯ã€‚</li>
</ul>

<p><img src="http://xelz.info/assets/2018/organizer-export.png" alt="rebuild from bitcode" /></p>

<ul>
  <li>å¯¼å‡ºStoreç‰ˆæœ¬æˆ–è€…ç›´æ¥è¿›è¡Œä¸Šä¼ æ—¶ï¼Œé»˜è®¤ä¼šå‹¾é€‰<code class="highlighter-rouge">Include bitcode for iOS content</code>ï¼Œå¦‚æœä¸å‹¾é€‰ï¼Œåˆ™è·Ÿå‰é¢ç±»ä¼¼ï¼Œå°†ä¼šå»é™¤å†…åµŒçš„bitcodeï¼Œç›´æ¥ä½¿ç”¨æœ¬åœ°ç¼–è¯‘çš„äºŒè¿›åˆ¶ä»£ç </li>
</ul>

<p><img src="http://xelz.info/assets/2018/organizer-upload.png" alt="include" /></p>

<p>å‹¾é€‰åç”Ÿæˆçš„ipaä¸­å°†ä¼š<code class="highlighter-rouge">åªåŒ…å«bitcode</code>ï¼Œè¿™ä¸ªipaæ˜¯æ— æ³•é‡ç­¾åå®‰è£…åˆ°è®¾å¤‡ä¸Šè¿›è¡Œæµ‹è¯•çš„ï¼Œå› ä¸ºé‡Œé¢æ²¡æœ‰ä»»ä½•å¯æ‰§è¡Œä»£ç ï¼š</p>

<p><img src="http://xelz.info/assets/2018/machoview1.png" alt="" /></p>

<p><code class="highlighter-rouge">__TEXT</code> å’Œ <code class="highlighter-rouge">__DATA</code> ç­‰è·Ÿå·²ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶ç›¸å…³çš„å†…å®¹ä¼šè¢«å…¨éƒ¨å»é™¤ï¼Œä½†æ˜¯ä¼šä¿ç•™<code class="highlighter-rouge">__LINKEDIT</code>ä¸­çš„éƒ¨åˆ†ä¿¡æ¯ï¼Œå…¶ä¸­æœ€é‡è¦çš„å°±æ˜¯ <code class="highlighter-rouge">LC_UUID</code>ï¼Œç”¨äºåœ¨é‡ç¼–ä¹‹åèƒ½è·ŸåŸå§‹çš„ç¬¦å·æ–‡ä»¶å¯¹åº”èµ·æ¥ï¼Œå¦‚æœç”¨æˆ·ä¸‹è½½ç»è¿‡AppStoreé‡ç¼–ä¹‹åçš„appå‘ç”Ÿäº†Crashï¼Œå¾—åˆ°çš„backtraceåœ°å€æ˜¯è·Ÿæœ¬åœ°ç¼–è¯‘çš„ç‰ˆæœ¬å¯¹åº”ä¸èµ·æ¥çš„ï¼Œéœ€è¦ç»“åˆUUIDå’Œä»App Store Connectä¸‹è½½çš„dSYMæ–‡ä»¶æ‰èƒ½å¾—åˆ°ç¬¦å·åŒ–çš„crashä¿¡æ¯ã€‚</p>

<p><img src="http://xelz.info/assets/2018/machoview2.png" alt="" /></p>

<h2 id="0x06-æ‹“å±•é˜…è¯»">0x06 æ‹“å±•é˜…è¯»</h2>

<h4 id="bitcodeä¸æ˜¯bytecode">bitcodeä¸æ˜¯bytecode</h4>

<p>bitcodeä¸èƒ½ç¿»è¯‘ä¸ºå­—èŠ‚ç (bytecode)ï¼Œæ˜¾ç„¶ä»å­—é¢ä¸Šçœ‹è¿™ä¸¤ä¸ªè¯ä»£è¡¨çš„å«ä¹‰å¹¶ä¸ç­‰åŒï¼šå­—èŠ‚ç æ˜¯æŒ‰ç…§å­—èŠ‚å­˜å–çš„ï¼Œä¸€èˆ¬å…¶æ§åˆ¶ä»£ç çš„æœ€å°å®½åº¦æ˜¯ä¸€ä¸ªå­—èŠ‚(ä¹Ÿå³8ä¸ªbits)ï¼Œè€Œbitcodeæ˜¯æŒ‰ä½(bit)å­˜å–ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç©ºé—´ã€‚æ¯”å¦‚ç”¨bitcodeä¸­ä½¿ç”¨<code class="highlighter-rouge">6-bit characters</code>æ¥ç¼–ç åªåŒ…å«å­—æ¯/æ•°å­—çš„å­—ç¬¦ä¸²</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'a' .. 'z' ---  0 .. 25 ---&gt; 00 0000 .. 01 1001
'A' .. 'Z' --- 26 .. 51 ---&gt; 01 1010 .. 11 0011
'0' .. '9' --- 52 .. 61 ---&gt; 11 0100 .. 11 1101
       '.' --- 62       ---&gt; 11 1110
       '_' --- 63       ---&gt; 11 1111
</code></pre></div></div>

<p>åœ¨è¿™ç§ç¼–ç æ¨¡å¼ä¸‹ï¼Œ4å­—èŠ‚çš„å­—ç¬¦ä¸²<code class="highlighter-rouge">abcd</code>åªç”¨3ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤º</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  char:     a   |    b   |    c   |    d
binary: 00 00 00|00|00 01|00 00|10|00 00 11
   hex:     00     |     10    |    83
</code></pre></div></div>

<p>å®Œæ•´çš„ç¼–ç æ ¼å¼å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£<a href="http://llvm.org/docs/BitCodeFormat.html">LLVM Bitcode File Format</a></p>

<h4 id="bitcodeçš„å…¼å®¹æ€§">bitcodeçš„å…¼å®¹æ€§</h4>

<p>bitcodeçš„æ ¼å¼ç›®å‰æ˜¯ä¸€ç›´åœ¨å˜åŒ–çš„ï¼Œå¹¶ä¸”æ— æ³•å‘å‰å…¼å®¹ï¼Œä¸¾ä¾‹æ¥è¯´Xcode8çš„ç¼–è¯‘å™¨æ— æ³•è¯»å–å¹¶è§£æxcode9äº§ç”Ÿçš„bitcodeã€‚</p>

<p>å¦å¤–è‹¹æœçš„bitcodeæ ¼å¼ä¸ç¤¾åŒºç‰ˆLLVMçš„bitcodeæœ‰ä¸€å®šå·®å¼‚ï¼Œä½†è‹¹æœå¹¶ä¸ä¼šåŠæ—¶å¼€æºXcodeæœ€æ–°ç‰ˆç¼–è¯‘å™¨çš„ä»£ç ï¼Œæ‰€ä»¥å¦‚æœä½ ä½¿ç”¨ç¬¬ä¸‰æ–¹åŸºäºç¤¾åŒºç‰ˆLLVMåˆ¶ä½œçš„ç¼–è¯‘å™¨è¿›è¡Œå¼€å‘ï¼Œä¸è¦å°è¯•å¼€å¯å¹¶æäº¤bitcodeåˆ°App Store Connectï¼Œå¦åˆ™ä¼šå› ä¸ºApp Store Connectè§£æä¸äº†ä½ çš„bitcodeè€Œè¢«æ‹’ã€‚</p>

<h4 id="bitcodeä¸æ˜¯æ¶æ„æ— å…³ä»£ç ">bitcodeä¸æ˜¯æ¶æ„æ— å…³ä»£ç </h4>

<p>å¦‚æœä¸€ä¸ªappåŒæ—¶è¦æ”¯æŒarmv7å’Œarm64ä¸¤ç§æ¶æ„ï¼Œé‚£ä¹ˆåŒä¸€ä¸ªæºä»£ç æ–‡ä»¶å°†ä¼šè¢«ç¼–è¯‘å‡ºä¸¤ä»½bitcodeï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä¸€å¼€å§‹ä»‹ç»LLVMçš„é‚£å¼ å›¾ä¸­ï¼Œå¹¶ä¸æ˜¯ä»£è¡¨åŒä¸€ä»½bitcodeä»£ç å¯ä»¥ç›´æ¥è¢«ç¼–è¯‘ä¸ºä¸åŒç›®æ ‡æœºå™¨çš„æœºå™¨ç ã€‚</p>

<p>LLVMåªæ˜¯ç»Ÿä¸€äº†ä¸­é—´è¯­è¨€çš„ç»“æ„å’Œè¯­æ³•æ ¼å¼ï¼Œä½†ä¸èƒ½åƒJavaé‚£æ ·ï¼ŒCompile Once &amp; Run Everywhere.</p>

<h4 id="å¦‚ä½•åˆ¤æ–­æ˜¯å¦å¼€å¯bitcode">å¦‚ä½•åˆ¤æ–­æ˜¯å¦å¼€å¯bitcode</h4>

<p>å¯ä»¥é€šè¿‡otoolæ£€æŸ¥äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šç±»ä¼¼è¿™æ ·çš„æ–¹æ³•ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>otool -arch armv7 -l xxxx.a | grep __LLVM | wc -l
</code></pre></div></div>

<p>é€šè¿‡åˆ¤æ–­æ˜¯å¦åŒ…å« <code class="highlighter-rouge">__LLVM</code> æˆ–è€…å…³é”®å­—æ¥åˆ¤æ–­æ˜¯å¦æ”¯æŒbitcodeï¼Œå…¶å®è¿™ç§æ–¹å¼æ˜¯å®Œå…¨é”™è¯¯çš„ï¼Œé€šè¿‡å‰é¢çš„æµ‹è¯•å¯ä»¥çŸ¥é“ï¼Œè¿™ç§æ–¹å¼åŒºåˆ†ä¸äº†bitcodeå’Œbitcode-markerï¼Œç¡®å®šæ˜¯å¦åŒ…å«bitcodeï¼Œè¿˜éœ€è¦æ£€æŸ¥otoolè¾“å‡ºä¸­<code class="highlighter-rouge">__LLVM</code> Segment çš„é•¿åº¦ï¼Œå¦‚æœé•¿åº¦åªæœ‰1ä¸ªå­—èŠ‚ï¼Œåˆ™å¹¶ä¸èƒ½ä»£è¡¨çœŸæ­£å¼€å¯äº†bitcodeï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ otool -l test_bitcode.o | grep -A 2  __LLVM | grep size
      size 0x0000000000000b10
      size 0x0000000000000042
$ otool -l test_bitcode_marker.o | grep -A 2  __LLVM | grep size
      size 0x0000000000000001
      size 0x0000000000000001
</code></pre></div></div>

<h4 id="bitcodeæ˜¯å¦èƒ½åç¼–è¯‘å‡ºæºä»£ç ">bitcodeæ˜¯å¦èƒ½åç¼–è¯‘å‡ºæºä»£ç </h4>

<p>ä»ç§‘å­¦ä¸¥è°¨çš„è§’åº¦æ¥è¯´ï¼Œæ— æ³•ç»™å‡ºç¡®å®šçš„ç­”æ¡ˆï¼Œä½†æ˜¯è¿™ä¸ªé—®é¢˜è·Ÿâ€œäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¦èƒ½åç¼–è¯‘å‡ºæºä»£ç â€æ˜¯ä¸€æ ·çš„é“ç†ã€‚ç¼–è¯‘æ˜¯ä¸€ä¸ªå°†æºä»£ç ä¸€å±‚ä¸€å±‚ä¸æ–­ä½çº§åŒ–çš„è¿‡ç¨‹ï¼Œæ¯ä¸€å±‚éƒ½å¯èƒ½ä¼šä¸¢å¤±ä¸€äº›ç‰¹æ€§ï¼Œäº§ç”Ÿä¸å¯é€†çš„è½¬æ¢ï¼ŒæŠŠæºä»£ç ç¼–è¯‘ä¸ºbitcodeæˆ–æ˜¯äºŒè¿›åˆ¶æœºå™¨ç æ˜¯äº”åæ­¥ä¹‹äºç™¾æ­¥çš„å…³ç³»ã€‚åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œåç¼–è¯‘bitcodeè·Ÿåç¼–è¯‘äºŒè¿›åˆ¶æ–‡ä»¶æ¯”è¦ç›¸å¯¹å®¹æ˜“ä¸€äº›ï¼Œä½†é€šè¿‡bitcodeåç¼–è¯‘å‡ºå’Œæºä»£ç è¯­ä¹‰å®Œå…¨ç›¸åŒçš„ä»£ç ï¼Œä¹Ÿæ˜¯å‡ ä¹ä¸å¯èƒ½çš„ã€‚</p>

<p>å¦å¤–ï¼Œä»å®‰å…¨çš„è§’åº¦è€ƒè™‘ï¼ŒXcode å¼•å…¥äº† <code class="highlighter-rouge">Symbol Hiding</code> å’Œ <code class="highlighter-rouge">Debug info Striping</code> æœºåˆ¶ï¼Œåœ¨é“¾æ¥æ—¶ï¼Œbitcodeä¸­æ‰€æœ‰éå¯¼å‡ºç¬¦å·å‡è¢«éšè—ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ <code class="highlighter-rouge">__hidden#0_</code> æˆ–è€… <code class="highlighter-rouge">__ir_hidden#1_</code> è¿™æ ·çš„å½¢å¼ï¼Œdebugä¿¡æ¯ä¹Ÿåªä¿ç•™äº†line-tableï¼Œæ‰€æœ‰è·Ÿæ–‡ä»¶è·¯å¾„ã€æ ‡è¯†ç¬¦ã€å¯¼å‡ºç¬¦å·ç­‰ç›¸å…³çš„ä¿¡æ¯å…¨éƒ¨éƒ½ä»bitcodeä¸­ç§»é™¤ï¼Œç›¸å½“äºåšäº†ä¸€å±‚æ··æ·†ï¼Œé˜²æ­¢æºä»£ç çº§åˆ«çš„ä¿¡æ¯æ³„éœ²ï¼Œå¯è°“æ˜¯ç…è´¹è‹¦å¿ƒã€‚</p>
:ET