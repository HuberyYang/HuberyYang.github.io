I"ç<p><strong>dispatch_apply</strong></p>

<p><code class="highlighter-rouge">dispatch_apply</code> å¯ä»¥åƒ for å¾ªç¯ä¸€æ ·å¤šæ¬¡æ‰§è¡Œå…¶ç»‘å®šçš„blockï¼Œåœ¨æ‰€æœ‰blockä»»åŠ¡å®Œæˆä¹‹åï¼Œå†è¿›è¡Œåç»­ä»»åŠ¡</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/* iterations  æ‰§è¡Œæ¬¡æ•°
 * queue  æ‰§è¡Œé˜Ÿåˆ—ï¼Œå¹¶è¡Œæˆ–è€…ä¸²è¡Œï¼Œä¼šå½±å“åˆ°ä»»åŠ¡æ‰§è¡Œé¡ºåº
 * block  å…·ä½“ä»»åŠ¡
 * size_t  æ‰§è¡Œä¸‹æ ‡ï¼ŒåŒºåˆ†ä¸åŒblockï¼Œä»£è¡¨æ¯ä¸ªblockæ‰§è¡Œé¡ºåº */
void dispatch_apply(size_t iterations, dispatch_queue_t queue, DISPATCH_NOESCAPE void (^block)(size_t));
</code></pre></div></div>

<ul>
  <li>ä½¿ç”¨ç¤ºä¾‹ï¼š</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);

dispatch_apply(5, queue, ^(NSUInteger index) {

   NSLog(@"thread = %@ , index = %ld",[NSThread currentThread],index);

});
</code></pre></div></div>

<p><img src="http://upload-images.jianshu.io/upload_images/2475558-40f37b251ba49e03?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä¸Šé¢æ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œå¦‚æœæ¢æˆä¸²è¡Œé˜Ÿåˆ—ï¼Œä¼šæŒ‰é¡ºåºæ‰§è¡Œblock
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_queue_t queue = dispatch_queue_create("com.serial", DISPATCH_QUEUE_SERIAL);
</code></pre></div></div>

<p><img src="http://upload-images.jianshu.io/upload_images/2475558-f4361745e2d88372?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<ul>
  <li>å¯¹äºæ‰¹é‡å¤„ç†ç›¸åŒçš„ä»»åŠ¡<code class="highlighter-rouge">dispatch_apply</code> ç›¸è¾ƒäº for å’Œ while èƒ½æ›´åˆç†çš„ä½¿ç”¨èµ„æº</li>
</ul>

<blockquote>
  <p>ä¸ºäº†è¿›è¡Œå¯¹æ¯”ï¼Œå…ˆåˆ›å»ºäº†ä¸€ä¸ªæ•°ç»„ä½œä¸ºå¤„ç†å¯¹è±¡ï¼ŒåŒ…å«50ä¸ªå…ƒç´ ï¼ˆps:50ä¸ªè™½ç„¶å°‘ï¼Œä½†ä¹Ÿèƒ½çœ‹åˆ°æ•ˆæœï¼‰ã€‚å¾ªç¯å’Œ<code class="highlighter-rouge">dispatch_apply</code>éƒ½ä½¿ç”¨å¹¶è¡Œé˜Ÿåˆ—</p>
</blockquote>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//æ¨¡æ‹Ÿæ“ä½œå¯¹è±¡
    NSMutableArray *testArr = [NSMutableArray array];
    for (int index = 0; index &lt; 50; index ++) {
        [testArr addObject:@(index)];
    }

//æ‰§è¡Œé˜Ÿåˆ—
    dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);
</code></pre></div></div>

<ol>
  <li>ä½¿ç”¨forå¾ªç¯</li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>for (int index = 0; index &lt; testArr.count; index ++) {

    dispatch_async(queue, ^{

        NSLog(@"queue = %@ , index = %@",[NSThread currentThread],testArr[index]);

    });
}
NSLog(@"æ‰§è¡Œå®Œæ¯•");
</code></pre></div></div>

<p><img src="http://upload-images.jianshu.io/upload_images/2475558-591bf1d205611708?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ä»ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼Œæ‰§è¡Œè¿‡ç¨‹åˆ›å»ºäº†å¤§é‡æ–°çº¿ç¨‹
</code></pre></div></div>

<ol>
  <li>ä½¿ç”¨<code class="highlighter-rouge">dispatch_apply</code></li>
</ol>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_apply(testArr.count, queue, ^(NSUInteger index) {

    NSLog(@"thread = %@ , index = %@",[NSThread currentThread],testArr[index]);

});
NSLog(@"æ‰§è¡Œå®Œæ¯•");
</code></pre></div></div>
<p><img src="http://upload-images.jianshu.io/upload_images/2475558-5bd4623e713c06c0?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<blockquote>
  <p>ç›¸è¾ƒäº for å¾ªç¯ï¼Œ<code class="highlighter-rouge">dispatch_apply</code>åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­æ–°åˆ›å»ºçš„çº¿ç¨‹æ•°è¦å°‘å¾—å¤šï¼Œå¹¶ä¸”<code class="highlighter-rouge">dispatch_apply</code>ä¼šåœ¨å…¶å…³è”çš„blockä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆåå†è¿›è¡Œåç»­ä»»åŠ¡çš„æ‰§è¡Œã€‚æ‰€ä»¥ï¼Œ<code class="highlighter-rouge">dispatch_apply</code>åœ¨æ‰¹é‡ä»»åŠ¡å¤„ç†ä¸­è¿˜æ˜¯å¾ˆå¥½ç”¨çš„ã€‚</p>
</blockquote>

<p><strong>dispatch_barrier</strong></p>

<p><code class="highlighter-rouge">barrier</code> æ„æ€æ˜¯æ …æ ï¼Œ<code class="highlighter-rouge">dispatch_barrier</code> ç§°ä¸ºæ …æ å‡½æ•°ï¼Œåœ¨å­˜åœ¨æ …æ å‡½æ•°ï¼Œä¸”ä½¿ç”¨<code class="highlighter-rouge">DISPATCH_QUEUE_CONCURRENT</code>åˆ›å»ºçš„å¹¶è¡Œé˜Ÿåˆ—(éå…¨å±€å¹¶è¡Œé˜Ÿåˆ—ï¼ŒåŸå› åé¢è¯´æ˜)æ—¶ï¼Œä»»åŠ¡æ‰§è¡Œé¡ºåºä¼šå˜ä¸ºï¼š æ …æ ä¹‹å‰çš„ä»»åŠ¡ â€”-&gt; æ …æ æœ¬èº«æäº¤çš„blockä»»åŠ¡ â€”-&gt; æ …æ ä¹‹åçš„ä»»åŠ¡ã€‚</p>

<p>å¸¸ç”¨çš„æœ‰ <code class="highlighter-rouge">dispatch_barrier_async</code> å’Œ <code class="highlighter-rouge">dispatch_barrier_sync</code> ï¼Œä¸¤è€…åŒºåˆ«åœ¨äºå¼‚æ­¥å’ŒåŒæ­¥ã€‚ä¸‹é¢ä»¥<code class="highlighter-rouge">dispatch_barrier_async</code> ä¸¾ä¾‹ï¼š</p>

<ul>
  <li>ä½¿ç”¨ä¸¾ä¾‹</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_queue_t cQueue = dispatch_queue_create("com.concurrent", DISPATCH_QUEUE_CONCURRENT);

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s1");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s2");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s3");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s4");
    });

    //æ·»åŠ æ …æ 
    dispatch_barrier_async(cQueue, ^{

        for (int index = 0; index &lt; 5; index ++) {
            [NSThread sleepForTimeInterval:1.0f];
            NSLog(@"thread = %@ , index = %d",[NSThread currentThread],index);
        }
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:3.0f];
        NSLog(@"y1");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:3.0f];
        NSLog(@"y2");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:3.0f];
        NSLog(@"y3");
    });
</code></pre></div></div>

<p><img src="http://upload-images.jianshu.io/upload_images/2475558-a76ba886ed930aed?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<ul>
  <li>æ³¨æ„ç‚¹</li>
</ul>

<p>ä½¿ç”¨æ …æ å‡½æ•°æ—¶éœ€è¦ä½¿ç”¨ <code class="highlighter-rouge">DISPATCH_QUEUE_CONCURRENT</code> åˆ›å»ºçš„å¹¶è¡Œé˜Ÿåˆ—ï¼Œå¦åˆ™ <code class="highlighter-rouge">dispatch_barrier_async</code> æ•ˆæœå°†ä¸ <code class="highlighter-rouge">dispatch_async</code> ç±»ä¼¼ï¼Œå¤±å»æ …æ çš„ä½œç”¨ã€‚
å°†ä¸Šé¢çš„ä¾‹å­ä¸­é˜Ÿåˆ—æ¢æˆ å…¨å±€å¹¶è¡Œé˜Ÿåˆ— å†çœ‹çœ‹ç»“æœ</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s1");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s2");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s3");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:5.0f];
        NSLog(@"s4");
    });

//æ›¿æ¢äº†æ‰§è¡Œé˜Ÿåˆ—åï¼Œæ …æ æ•ˆæœæ¶ˆå¤±    
dispatch_barrier_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{

        for (int index = 0; index &lt; 5; index ++) {
            [NSThread sleepForTimeInterval:1.0f];
            NSLog(@"thread = %@ , index = %d",[NSThread currentThread],index);
        }
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:3.0f];
        NSLog(@"y1");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:3.0f];
        NSLog(@"y2");
    });

    dispatch_async(cQueue, ^{
        [NSThread sleepForTimeInterval:3.0f];
        NSLog(@"y3");
    });
</code></pre></div></div>

<p><img src="http://upload-images.jianshu.io/upload_images/2475558-5922ecf91e31ba00?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="" /></p>

<p>ä»æˆªå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ …æ å·²ç»å¤±æ•ˆï¼›éœ€é…åˆ <code class="highlighter-rouge">DISPATCH_QUEUE_CONCURRENT</code> åˆ›å»ºçš„é˜Ÿåˆ—æ‰èƒ½ç”Ÿæ•ˆã€‚</p>
:ET